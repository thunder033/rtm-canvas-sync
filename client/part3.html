<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Canvas Syncing :: Pt 3</title>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>

    <script>
        // hack in exports so things don't break
        window.exports = window.exports || {};
    </script>
    <script src="priority-queue.js"></script>

    <script type="text/babel">
        function connect() {
            const socket = io.connect(`http://${window.location.host}`, {query: "room=boxes"});

            const BOX_SIZE = 30;
            const CANVAS_SIZE = 500;

            const users = [];

            const canvas = document.querySelector('#canvas');
            canvas.width = canvas.height = CANVAS_SIZE;
            const ctx = canvas.getContext('2d');

            const drawQueue = new PriorityQueue();

            const pageLoadTime = (new Date()).getTime();

            socket.on('connect', () => {
                socket.emit('join', {name: Math.random().toString()});
            });

            socket.on('sendRoomUsers', (data) => {
                users.length = 0;
                Array.push.apply(users, data);
            });

            socket.on('userMoved', (data) => {

            });

            function updatePosition(e) {
                const pos = getTargetPosition(e);
                const time = pageLoadTime + ~~performance.now();

                const update = {
                    x: pos.x,
                    y: pos.y,
                    time: time
                };

                socket.emit('updatePosition', update);
            }

            canvas.addEventListener('click', updatePosition);

            function draw(queue) {
                ctx.clearRect(0, 0, 500, 500);

                const it = queue.getIterator();
                let box = null;

                while (!it.isEnd()) {
                    box = it.next();
                    ctx.fillStyle = `hsla(${box.hue},80%,45%,1)`;
                    ctx.fillRect(box.x, box.y, BOX_SIZE, BOX_SIZE);
                }

                requestAnimationFrame(() => draw(drawQueue));
            }

            requestAnimationFrame(() => draw(drawQueue));
        }

        window.addEventListener('load', connect);
    </script>
</head>
<body>

</body>
</html>